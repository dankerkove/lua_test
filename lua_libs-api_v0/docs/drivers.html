

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Drivers &mdash; SmartThings Edge Device Drivers  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="SmartThings Edge Device Drivers  documentation" href="index.html"/>
        <link rel="up" title="&lt;no title&gt;" href="reference/index.html"/>
        <link rel="next" title="Capabilities" href="capabilities.html"/>
        <link rel="prev" title="Constants" href="zwave/generated/ZwaveplusInfo/constants.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> SmartThings Edge Device Drivers
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Guides:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="guides/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides/first-driver.html">Writing your first Lua driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides/package.html">Package Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides/lan.html">LAN Edge Device Driver Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides/rpc-client.html">Writing an RPC Client Driver</a></li>
</ul>
<p class="caption"><span class="caption-text">References:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lua_environment.html">Lua Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="log.html">Logging Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utils Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="buf.html">Buffer Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="zigbee/zigbee.html">Zigbee Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="zwave/zwave.html">Z-Wave Libraries</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Drivers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#driver-class-documentation">Driver Class Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#driver-template-options">Driver Template Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lifecycle-event-handlers">Lifecycle Event Handlers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example">example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#capability-command-handlers">Capability Command Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subdrivers">SubDrivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#subdriver-class-documentation">SubDriver Class Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#driver-tests">Driver tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="capabilities.html">Capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="device.html">Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="dispatchers.html">Dispatchers</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_tests.html">Driver Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastore.html">Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="socket.html">Socket Library</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SmartThings Edge Device Drivers</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="reference/index.html">&lt;no title&gt;</a> &raquo;</li>
        
      <li>Drivers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/drivers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="drivers">
<h1>Drivers<a class="headerlink" href="#drivers" title="Permalink to this headline">¶</a></h1>
<p>Drivers are the replacement for DTHs (Device Type Handlers) but are more specific in their responsibilities.  A driver represents
the code necessary to provide the needed behavior for a device.  Within the Lua code base, a “driver”
represents a table containing the context necessary for executing device behaviors.  Unlike DTHs, a separate
driver instance will not run for each device; instead a single “driver” will handle all devices that are
set to use it.  Unlike DTHs, drivers behave functionally as if they are long running. That is,
the script will behave as if it is always running and waiting for input on the devices it is registered to
handle.  See <code class="xref lua lua-class docutils literal notranslate"><span class="pre">Driver</span></code> for the description of what a “driver” table will
contain.  There are additional functions and structures provided on a per-protocol basis that are specific to those
protocols.</p>
<p>For most use cases you can create a template that has some basic behavior defined for a driver and then pass it to
<code class="docutils literal notranslate"><span class="pre">Driver(&lt;driver_name&gt;,</span> <span class="pre">&lt;driver_template&gt;)</span></code> to handle setting up most of the defaults.  Below is an
example of a driver setup:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">yeelight_driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">init_driver</span><span class="p">(</span><span class="s2">&quot;yeelight&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">capability_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switch</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switch</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">on</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_switch_on</span><span class="p">,</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switch</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">off</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_switch_off</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setLevel</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_set_level</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorControl</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorControl</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setColor</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_set_color</span><span class="p">,</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorControl</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setHue</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_set_hue</span><span class="p">,</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorControl</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setSaturation</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_set_saturation</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorTemperature</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">colorTemperature</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setColorTemperature</span><span class="p">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_handlers</span><span class="p">.</span><span class="n">handle_set_color_temp</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In this case, the only pieces of the template being specified are the command handlers for capability commands for these
devices.  Also note that some specific protocols may have more tailored options, and a more tailored init function for
the driver contexts.  See the individual protocols for examples.</p>
<div class="section" id="driver-class-documentation">
<h2>Driver Class Documentation<a class="headerlink" href="#driver-class-documentation" title="Permalink to this headline">¶</a></h2>
<dl class="lua class">
<dt id="Driver">
<em class="property">class </em><code class="sig-name descname">Driver</code><a class="headerlink" href="#Driver" title="Permalink to this definition">¶</a></dt>
<dd><p>This is a template class to define the various parts of a driver table.  The Driver object represents all of the
state necessary for running and supporting the operation of this class of devices.  This can be as specific as a
single model of device, or if there is much shared functionality can manage several different models and
manufacturers.</p>
<p>Drivers go through initial set up on hub boot, or initial install, but after that the Drivers are considered
long running.  That is, they will behave as if they run forever.  As a result, they should have a main run loop
that continues to check for work/things to process and handles it when available.  For MOST uses the provided
run function should work, and there should be no reason to overwrite the existing run loop.</p>
<dl class="lua attribute">
<dt id="Driver.NAME">
<code class="sig-name descname">NAME</code><em class="property">: </em>str<a class="headerlink" href="#Driver.NAME" title="Permalink to this definition">¶</a></dt>
<dd><p>a name used for debug and error output</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.capability_channel">
<code class="sig-name descname">capability_channel</code><em class="property">: </em>message_channel<a class="headerlink" href="#Driver.capability_channel" title="Permalink to this definition">¶</a></dt>
<dd><p>the communication channel for capability commands/events</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.lifecycle_channel">
<code class="sig-name descname">lifecycle_channel</code><em class="property">: </em>message_channel<a class="headerlink" href="#Driver.lifecycle_channel" title="Permalink to this definition">¶</a></dt>
<dd><p>the communication channel for device lifecycle events</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.timer_api">
<code class="sig-name descname">timer_api</code><em class="property">: </em>timer_api<a class="headerlink" href="#Driver.timer_api" title="Permalink to this definition">¶</a></dt>
<dd><p>utils related to timer functionality</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.device_api">
<code class="sig-name descname">device_api</code><em class="property">: </em>device_api<a class="headerlink" href="#Driver.device_api" title="Permalink to this definition">¶</a></dt>
<dd><p>utils related to device functionality</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.environment_channel">
<code class="sig-name descname">environment_channel</code><em class="property">: </em>message_channel<a class="headerlink" href="#Driver.environment_channel" title="Permalink to this definition">¶</a></dt>
<dd><p>the communication channel for environment info updates</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.timers">
<code class="sig-name descname">timers</code><em class="property">: </em>table<a class="headerlink" href="#Driver.timers" title="Permalink to this definition">¶</a></dt>
<dd><p>this will contain a list of in progress timers running for the driver</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.capability_dispatcher">
<code class="sig-name descname">capability_dispatcher</code><em class="property">: </em>CapabilityCommandDispatcher<a class="headerlink" href="#Driver.capability_dispatcher" title="Permalink to this definition">¶</a></dt>
<dd><p>dispatcher for routing capability commands</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.lifecycle_dispatcher">
<code class="sig-name descname">lifecycle_dispatcher</code><em class="property">: </em>DeviceLifecycleDispatcher<a class="headerlink" href="#Driver.lifecycle_dispatcher" title="Permalink to this definition">¶</a></dt>
<dd><p>dispatcher for routing lifecycle events</p>
</dd></dl>

<dl class="lua attribute">
<dt id="Driver.sub_drivers">
<code class="sig-name descname">sub_drivers</code><em class="property">: </em>list[SubDriver]<a class="headerlink" href="#Driver.sub_drivers" title="Permalink to this definition">¶</a></dt>
<dd><p>A list of sub_drivers that contain more specific behavior behind a can_handle function</p>
</dd></dl>

<dl class="lua method">
<dt id="Driver.get_device_info">
<em class="property"> </em><code class="sig-name descname">get_device_info</code><span class="sig-paren">(</span><em class="sig-param">device_uuid</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.get_device_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the device table containing information about a device running on this driver.  This is routed through the
driver to allow the driver to set up any driver specific information or make any calculations necessary.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device_uuid</strong> (<em>str</em>) – the UUID of the device to query</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the device associated with the UUID</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="device.html#Device" title="Device">Device</a></p>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.call_with_delay">
<em class="property"> </em><code class="sig-name descname">call_with_delay</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">delay_s</em>, <em class="sig-param">callback</em>, <em class="sig-param">name</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.call_with_delay" title="Permalink to this definition">¶</a></dt>
<dd><p>Set up a one shot timer to hit the callback after delay_s seconds</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver setting up the timer</p></li>
<li><p><strong>delay_s</strong> (<em>number</em>) – the number of seconds to wait before hitting the callback</p></li>
<li><p><strong>callback</strong> (<em>function</em>) – the function to call when the timer expires. &#64;see Driver.timer_callback_template</p></li>
<li><p><strong>name</strong> (<em>str</em>) – an optional name for the timer</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the created timer</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>timer</p>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.call_on_schedule">
<em class="property"> </em><code class="sig-name descname">call_on_schedule</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">interval_s</em>, <em class="sig-param">callback</em>, <em class="sig-param">name</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.call_on_schedule" title="Permalink to this definition">¶</a></dt>
<dd><p>Set up a periodic timer to hit the callback every interval_s seconds</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver setting up the timer</p></li>
<li><p><strong>interval_s</strong> (<em>number</em>) – the number of seconds to wait between hitting the callback</p></li>
<li><p><strong>callback</strong> (<em>function</em>) – the function to call when the timer expires. &#64;see Driver.timer_callback_template</p></li>
<li><p><strong>name</strong> (<em>str</em>) – an optional name for the timer</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the created timer</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>timer</p>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.cancel_timer">
<em class="property"> </em><code class="sig-name descname">cancel_timer</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">t</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.cancel_timer" title="Permalink to this definition">¶</a></dt>
<dd><p>Cancel a timer set up on this driver</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver with the timer</p></li>
<li><p><strong>t</strong> (<em>Timer</em>) – the timer to cancel</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.capability_message_handler">
<em class="property"> </em><code class="sig-name descname">capability_message_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">capability_channel</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.capability_message_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Default handler that can be registered for the capability message channel</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the capability commands</p></li>
<li><p><strong>capability_channel</strong> (<em>message_channel</em>) – the capability message channel with data to be read</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.handle_capability_command">
<em class="property"> </em><code class="sig-name descname">handle_capability_command</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">device</em>, <em class="sig-param">cap_command</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.handle_capability_command" title="Permalink to this definition">¶</a></dt>
<dd><p>Default capability command handler.  This takes the parsed command and will look up the command handler and call it</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the capability commands</p></li>
<li><p><strong>device</strong> (<a class="reference internal" href="device.html#Device" title="Device"><em>Device</em></a>) – the device that this command was sent to</p></li>
<li><p><strong>cap_command</strong> (<em>table</em>) – the capability command table including the capability, command, component and args</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.lifecycle_message_handler">
<em class="property"> </em><code class="sig-name descname">lifecycle_message_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">lifecycle_channel</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.lifecycle_message_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Default handler that can be registered for the device lifecycle events</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the device lifecycle events</p></li>
<li><p><strong>lifecycle_channel</strong> (<em>message_channel</em>) – the lifecycle message channel with data to be read</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.discovery_message_handler">
<em class="property"> </em><code class="sig-name descname">discovery_message_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">discovery_channel</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.discovery_message_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Default handler that can be registered for the device discovery events</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the device discovery events</p></li>
<li><p><strong>discovery_channel</strong> (<em>message_channel</em>) – the discovery message channel with data to be read</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.environment_info_handler">
<em class="property"> </em><code class="sig-name descname">environment_info_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">environment_channel</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.environment_info_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Default handler that can be registered for the environment info messages</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the device lifecycle events</p></li>
<li><p><strong>environment_channel</strong> (<em>message_channel</em>) – the environment update message channel</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt>
<em class="property"> </em><code class="sig-name descname">get_device_info</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">device_uuid</em>, <em class="sig-param">force_refresh</em><span class="sig-paren">)</span></dt>
<dd><p>Default function for getting and caching device info on a driver</p>
<p>By default this will use the devices api to request information about the device id provided
it will then cache that information on the driver.  The information will be stored as a table
after being decoded from the JSON sent across.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver running</p></li>
<li><p><strong>device_uuid</strong> (<em>str</em>) – the uuid of the device to get info for</p></li>
<li><p><strong>force_refresh</strong> (<em>boolean</em>) – if true, re-request from the driver api instead of returning cached value</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.try_create_device">
<em class="property"> </em><code class="sig-name descname">try_create_device</code><span class="sig-paren">(</span><em class="sig-param">device_metadata</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.try_create_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Send a request to create a new device.</p>
<p>NOTE: At this time, only LAN type devices can be created via this api.</p>
<p>Example usage: <a href="#id1"><span class="problematic" id="id2">``</span></a>local metadata = {
type = “LAN”,
device_network_id = “24FD5B0001044502”,
label = “Kitchen Smart Bulb”,
profile = “bulb.rgb.v1”,
manufacturer = “WiFi Smart Bulb Co.”,
model = “WiFi Bulb 9000”,
vendor_provided_label = “Kitchen Smart Bulb”
})</p>
<p>driver:try_create_device(metadata))``</p>
<p>All metadata fields are type string. Valid metadata fields are:</p>
<p>type - network type of the device. Must be “LAN”. (required)
device_network_id - unique identifier specific for this device (required)
label - label for the device (required)
profile - profile name defined in the profile .yaml file (required)
parent_device_id - device id of a parent device
manufacturer - device manufacturer
model - model name of the device
vendor_provided_label - device label provided by the manufacturer/vendor (typically the same as label during device creation)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device_metadata</strong> (<em>table</em>) – A table of device metadata</p>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.register_channel_handler">
<em class="property"> </em><code class="sig-name descname">register_channel_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">message_channel</em>, <em class="sig-param">callback</em>, <em class="sig-param">name</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.register_channel_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Function to register a message_channel handler</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle message events</p></li>
<li><p><strong>message_channel</strong> (<em>message_channel</em>) – the message channel to listen to input on</p></li>
<li><p><strong>callback</strong> (<em>function</em>) – the callback function to call when there is data on the message channel</p></li>
<li><p><strong>name</strong> (<em>str</em>) – Optional name for the channel handler, used for logging</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.unregister_channel_handler">
<em class="property"> </em><code class="sig-name descname">unregister_channel_handler</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">message_channel</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.unregister_channel_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Function to unregister a message_channel handler</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to handle the message events</p></li>
<li><p><strong>message_channel</strong> (<em>message_channel</em>) – the message channel to stop listening for input on</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="lua staticmethod">
<dt id="Driver.standardize_sub_drivers">
<em class="property">static </em><code class="sig-name descname">standardize_sub_drivers</code><span class="sig-paren">(</span><em class="sig-param">driver</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.standardize_sub_drivers" title="Permalink to this definition">¶</a></dt>
<dd><p>Standardize the structure of the sub driver structure of this driver</p>
<p>The handlers registered as a part of the base driver file (or capability defaults) are
assumed to be the default behavior of the driver.  However, if there is need for a subset
of devices to override the base behavior for one reason or another (e.g. manufacturer or
model specific behavior), a value can be added to the “sub_drivers”.  Each sub_driver must
contain a <cite>can_handle</cite> function of the signature <cite>can_handle(opts, driver, device, …)</cite>
where opts can be used to provide context specific information necessary to determine if
the sub_driver should be responsible for some type of work.  The most common use for the
sub drivers will be to provide capabiltiy/zigbee/zwave handlers that need to override the
default for the driver.  It may optionally also contain its own <cite>sub_drivers</cite> containing
further subservient sets.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>driver</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver</p>
</dd>
</dl>
</dd></dl>

<dl class="lua staticmethod">
<dt id="Driver.populate_capability_dispatcher_from_sub_drivers">
<em class="property">static </em><code class="sig-name descname">populate_capability_dispatcher_from_sub_drivers</code><span class="sig-paren">(</span><em class="sig-param">driver</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.populate_capability_dispatcher_from_sub_drivers" title="Permalink to this definition">¶</a></dt>
<dd><p>Recursively build the capability dispatcher structure from sub_drivers</p>
<p>This will recursively follow the <cite>sub_drivers</cite> defined on the driver and build
a structure that will correctly find and execute a handler that matches.  It should be
noted that a child handler will always be preferred over a handler at the same level,
but that if multiple child handlers report that they can handle a message, it will be
sent to each handler that reports it can handle the message.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>driver</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver</p>
</dd>
</dl>
</dd></dl>

<dl class="lua staticmethod">
<dt id="Driver.populate_lifecycle_dispatcher_from_sub_drivers">
<em class="property">static </em><code class="sig-name descname">populate_lifecycle_dispatcher_from_sub_drivers</code><span class="sig-paren">(</span><em class="sig-param">driver</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.populate_lifecycle_dispatcher_from_sub_drivers" title="Permalink to this definition">¶</a></dt>
<dd><p>Recursively build the lifecycle dispatcher structure from sub_drivers</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>driver</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver</p>
</dd>
</dl>
</dd></dl>

<dl class="lua staticmethod">
<dt id="Driver.init">
<em class="property">static </em><code class="sig-name descname">init</code><span class="sig-paren">(</span><em class="sig-param">cls</em>, <em class="sig-param">name</em>, <em class="sig-param">template</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.init" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a driver template and name initialize the context</p>
<p>This is used to build the driver context that will be passed around to provide access to various state necessary
for operation</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>cls</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – class to be instantiated</p></li>
<li><p><strong>name</strong> (<em>str</em>) – the name of the driver used for logging</p></li>
<li><p><strong>template</strong> (<em>table</em>) – a template with any override or necessary driver information</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the constructed driver context</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#Driver" title="Driver">Driver</a></p>
</dd>
</dl>
</dd></dl>

<dl class="lua method">
<dt id="Driver.run">
<em class="property"> </em><code class="sig-name descname">run</code><span class="sig-paren">(</span><em class="sig-param">self</em><span class="sig-paren">)</span><a class="headerlink" href="#Driver.run" title="Permalink to this definition">¶</a></dt>
<dd><p>Function to run a driver</p>
<p>This will run an “infinite” loop for this driver.  It will wait for input on any message channel that has a handler
registered for it through the register_channel_handler function.  In addition it will wait for any registered timers
to expire and trigger as well.  Whenever data becomes available on one of the message channels the callback will
be called and then it will go back to waiting for input.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>self</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver to run</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="driver-template-options">
<h2>Driver Template Options<a class="headerlink" href="#driver-template-options" title="Permalink to this headline">¶</a></h2>
<p>To create a driver, use the <code class="docutils literal notranslate"><span class="pre">Driver(&lt;driver_name&gt;,</span> <span class="pre">&lt;driver_template&gt;)</span></code> call to
create the driver object.  There are a number of things that can be included within the driver template that is passed
in.</p>
<dl class="simple">
<dt>lifecycle_handlers</dt><dd><p>A structure of registered handlers for a variety of different events pertaining to the lifecycle of devices</p>
</dd>
<dt>capability_handlers</dt><dd><p>The structure mentioned in the <a class="reference internal" href="zwave/defaults.html#capability-handlers"><span class="std std-ref">capabilities handlers</span></a> section used to handle
SmartThings capability commands</p>
</dd>
<dt>sub_drivers</dt><dd><p>The list of <a class="reference internal" href="#sub-drivers"><span class="std std-ref">sub drivers</span></a> that are under this driver.</p>
</dd>
</dl>
<div class="section" id="lifecycle-event-handlers">
<h3>Lifecycle Event Handlers<a class="headerlink" href="#lifecycle-event-handlers" title="Permalink to this headline">¶</a></h3>
<p>All drivers, regardless of the underlying protocol, will by default support the definition of a <code class="docutils literal notranslate"><span class="pre">lifecycle_handlers</span></code>
structure that will allow you to provide a set of functions that will be called when any of the following device events
happen</p>
<dl class="simple">
<dt>init</dt><dd><p>This device init function will be called any time a device object needs to be instantiated within the driver.
There are 2 main cases where this happens: 1) the driver just started up and needs to create the objects for
existing devices and 2) a device was newly added to the driver.</p>
</dd>
<dt>added</dt><dd><p>A device was newly added to this driver.  This represents when the device is, for the first time, assigned to run
with this driver.  For example, when it is first joined to the network and fingerprinted to this driver.</p>
</dd>
<dt>doConfigure</dt><dd><p>This is an event that will be sent when the platform believes the device needs to go through provisioning for it to
work as expected.  The most common situation for this is when the device is first added to the platform, but there
are other protocol specific cases that this may be triggered as well.</p>
</dd>
<dt>infoChanged</dt><dd><p>This represents a change that has happened in the data representing the device on the SmartThings platform.  An
example could be a change to the name of the device.</p>
</dd>
<dt>deleted</dt><dd><p>This represents a device being removed from this driver.</p>
</dd>
</dl>
<p>Each of these can be defined in the <code class="docutils literal notranslate"><span class="pre">lifecycle_handlers</span></code> table as a key with the corresponding function that will be
called when the event happens.  These functions will have the signature of
<code class="docutils literal notranslate"><span class="pre">event_handler(driver,</span> <span class="pre">device,</span> <span class="pre">event,</span> <span class="pre">args)</span></code> where <code class="docutils literal notranslate"><span class="pre">event</span></code> is the string matching the above event and args is
a table with key-values specific to the event.  The only event that currently uses the <code class="docutils literal notranslate"><span class="pre">args</span></code> is the <code class="docutils literal notranslate"><span class="pre">infoChanged</span></code>
event which provides the key arg <code class="docutils literal notranslate"><span class="pre">old_st_store</span></code> which is the table representation of the device info from before this
event happened with the <code class="docutils literal notranslate"><span class="pre">device</span></code> arg containing the new up to date information.</p>
<p>There is also some default behavior that will always happen for certain events.  <code class="docutils literal notranslate"><span class="pre">added</span></code> will also trigger an <code class="docutils literal notranslate"><span class="pre">init</span></code>
after it has completed the <code class="docutils literal notranslate"><span class="pre">added</span></code> behavior.  <code class="docutils literal notranslate"><span class="pre">removed</span></code> will remove the device from the device cache and make
the device inoperable.</p>
<p>Further these lifecycle handlers can be defined in <a class="reference internal" href="#sub-drivers"><span class="std std-ref">SubDrivers</span></a> if there is some differntiation
needed between devices within a driver.</p>
</div>
</div>
<div class="section" id="example">
<h2>example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Here is a simple example in which a device needs to do some specific configuration and setup.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.capabilities&quot;</span>
<span class="kd">local</span> <span class="n">ZigbeeDriver</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee&quot;</span>
<span class="kd">local</span> <span class="n">defaults</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee.defaults&quot;</span>

<span class="kd">local</span> <span class="kr">function</span> <span class="nf">configure_device</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">device</span><span class="p">:</span><span class="n">configure</span><span class="p">()</span>
    <span class="c1">-- some driver specific behavior</span>
    <span class="n">self</span><span class="p">.</span><span class="n">arbitrary_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">arbitrary_value</span> <span class="o">+</span> <span class="mi">1</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">device_init</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
   <span class="n">self</span><span class="p">.</span><span class="n">device_tracker</span><span class="p">[</span><span class="n">device</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;device initted&quot;</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">zigbee_outlet_driver_template</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">supported_capabilities</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">capabilities</span><span class="p">.</span><span class="n">switch</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">lifecycle_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">init</span> <span class="o">=</span> <span class="n">device_init</span><span class="p">,</span>
    <span class="n">doConfigure</span> <span class="o">=</span> <span class="n">configure_device</span>
  <span class="p">},</span>
  <span class="n">device_tracker</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="n">defaults</span><span class="p">.</span><span class="n">register_for_default_handlers</span><span class="p">(</span><span class="n">zigbee_outlet_driver_template</span><span class="p">,</span> <span class="n">zigbee_outlet_driver_template</span><span class="p">.</span><span class="n">supported_capabilities</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">zigbee_outlet</span> <span class="o">=</span> <span class="n">ZigbeeDriver</span><span class="p">(</span><span class="s2">&quot;zigbee_bulb&quot;</span><span class="p">,</span> <span class="n">zigbee_outlet_driver_template</span><span class="p">)</span>
<span class="n">zigbee_outlet</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="capability-command-handlers">
<span id="capability-handlers"></span><h3>Capability Command Handlers<a class="headerlink" href="#capability-command-handlers" title="Permalink to this headline">¶</a></h3>
<p>All drivers, regardless of the underlying protocol, will by default support the definition of a <code class="docutils literal notranslate"><span class="pre">capability_handlers</span></code>
structure that will allow you to map the capability commands to a function meant to support that command.  For more
information about the use of capabilities within drivers, including the <code class="docutils literal notranslate"><span class="pre">capability_handlers</span></code> structure, see
<a class="reference internal" href="capabilities.html"><span class="doc">capabilities</span></a>.</p>
</div>
<div class="section" id="subdrivers">
<span id="sub-drivers"></span><h3>SubDrivers<a class="headerlink" href="#subdrivers" title="Permalink to this headline">¶</a></h3>
<p>Because drivers are no longer a separate instance for each device, it becomes much easier to support
multiple different-but-similar devices (e.g. both a Zigbee on/off/dim bulb and a Zigbee RGBW bulb) in the same driver
to maximize similar behavior between devices; a driver can support any number of different profiles.  However,
there still exists the problem of handling abnormal devices, for example a device that is exactly the same in handling
and behavior except for one command which has a slightly different handling.  You could register a single
<a class="reference internal" href="zwave/defaults.html#capability-handlers"><span class="std std-ref">capability handler</span></a> (or other protocol specific handler) with branching within the handler
for each device variation.  However, this can quickly get out of control with long lists of if/else blocks.  This is the
problem that <code class="docutils literal notranslate"><span class="pre">SubDrivers</span></code> helps solve.  With this solution, each subdriver will provide a single <code class="docutils literal notranslate"><span class="pre">can_handle</span></code>
function that can be used to determine if the given subdriver should handle _something_.  Below is the function
definition:</p>
<dl class="lua function">
<dt id="can_handle">
<em class="property"> </em><code class="sig-name descname">can_handle</code><span class="sig-paren">(</span><em class="sig-param">opts</em>, <em class="sig-param">driver</em>, <em class="sig-param">device</em>, <em class="sig-param">...</em><span class="sig-paren">)</span><a class="headerlink" href="#can_handle" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if this subdriver can handle a given context</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>opts</strong> (<em>table</em>) – A table containing optional arguments that can be used to determine if something is handleable</p></li>
<li><p><strong>driver</strong> (<a class="reference internal" href="#Driver" title="Driver"><em>Driver</em></a>) – the driver context</p></li>
<li><p><strong>device</strong> (<a class="reference internal" href="device.html#Device" title="Device"><em>Device</em></a>) – the device we are checking handling against</p></li>
<li><p><strong>...</strong> (<em>vararg</em>) – The additional context values, typically the message that is being checked for handling</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>As you can see, some of the args are a bit nebulous including a vararg option at the end.  This is to allow for the
flexibility of using the same function in many contexts.  However, the most common example would be to handle devices of
a specific model (or manufacturer) in which case the function can be very simple:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">my_subdriver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">can_handle</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="p">...)</span>
        <span class="kr">return</span> <span class="n">device</span><span class="p">:</span><span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;modelOne&quot;</span>
    <span class="kr">end</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this case, this is for a <a class="reference internal" href="zigbee/driver.html#ZigbeeDriver" title="ZigbeeDriver"><code class="xref lua lua-class docutils literal notranslate"><span class="pre">ZigbeeDriver</span></code></a> so we are using the function to get the model of the
device and branching on that, and we will use that in all situations for the subdriver.</p>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">can_handle</span></code> function, you can incorporate <a class="reference internal" href="zwave/defaults.html#capability-handlers"><span class="std std-ref">capability handlers</span></a> or any
other protocol specific handlers. These will be built into the <a class="reference internal" href="dispatchers.html"><span class="doc">dispatcher</span></a>
for these handlers, and follow the corresponding rules for dispatching to the correct handler in the context of that
dispatcher.  Additionally, this subdriver could be used for whatever driver-specific uses are needed, specific to your use case.</p>
<div class="section" id="id1">
<h4>Example<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Below is an example showing a base driver utilizing subdrivers.  It has a base driver that provides the
Zigbee standard support for switch and switchLevel capabilities.  It registers 2 subdrivers, split into separate files
to make organization and understanding the blocks of behavior better.  First, it has a <code class="docutils literal notranslate"><span class="pre">manufacturer_one.lua</span></code> subdriver
whose <code class="docutils literal notranslate"><span class="pre">can_handle</span></code> verifies that the device has the correct manufacturer.  If the device does match that manufacturer,
then instead of using the standard switchLevel support it will arbitrarily generate an event 15 less than it would
otherwise when the device reports, and it will set it to 15 less than the commands sent to it.  Similarly, the
<code class="docutils literal notranslate"><span class="pre">manufacturer_two.lua</span></code> works functionally the same but with a different manufacturer and different level offset.  The
complete driver could now support any standard Zigbee bulb that supported switch and switchLevel as well as two specific
manufacturers bulbs who arbitrarily offset the levels.</p>
<div class="section" id="init-lua">
<h5>init.lua<a class="headerlink" href="#init-lua" title="Permalink to this headline">¶</a></h5>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.capabilities&quot;</span>
<span class="kd">local</span> <span class="n">ZigbeeDriver</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee&quot;</span>
<span class="kd">local</span> <span class="n">defaults</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee.defaults&quot;</span>

<span class="kd">local</span> <span class="n">zigbee_man_model_driver_template</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;man-model-example&quot;</span><span class="p">,</span>
  <span class="n">supported_capabilities</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">capabilities</span><span class="p">.</span><span class="n">switch</span><span class="p">,</span>
    <span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">sub_drivers</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;manufacturer_one&quot;</span><span class="p">),</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;manufacturer_two&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">defaults</span><span class="p">.</span><span class="n">register_for_default_handlers</span><span class="p">(</span><span class="n">zigbee_man_model_driver_template</span><span class="p">,</span>
                                       <span class="n">zigbee_man_model_driver_template</span><span class="p">.</span><span class="n">supported_capabilities</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">zigbee_man_model_driver</span> <span class="o">=</span> <span class="n">ZigbeeDriver</span><span class="p">(</span><span class="n">zigbee_man_model_driver_template</span><span class="p">)</span>
<span class="n">zigbee_man_model_driver</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="manufacturer-one-lua">
<h5>manufacturer_one.lua<a class="headerlink" href="#manufacturer-one-lua" title="Permalink to this headline">¶</a></h5>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">zcl_clusters</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee.zcl.clusters&quot;</span>
<span class="kd">local</span> <span class="n">LevelControlCluster</span> <span class="o">=</span> <span class="n">zcl_clusters</span><span class="p">.</span><span class="n">LevelControlCluster</span>
<span class="kd">local</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.capabilities&quot;</span>

<span class="kd">local</span> <span class="n">manufacturer_one_handler</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;ManufacturerOne&quot;</span><span class="p">,</span>
  <span class="n">zigbee_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">CurrentLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
          <span class="c1">-- Arbitrarily subtract 15 for example purposes</span>
          <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">level</span><span class="p">(</span><span class="nb">math.floor</span><span class="p">((</span><span class="n">value</span><span class="p">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">254.0</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">15</span><span class="p">))</span>
        <span class="kr">end</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">capability_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="c1">-- Arbitrarily subtract 15 for example purposes</span>
        <span class="kd">local</span> <span class="n">level</span> <span class="o">=</span> <span class="nb">math.floor</span><span class="p">((</span><span class="n">command</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">254</span><span class="p">)</span>
        <span class="n">device</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">MoveToLevelWithOnOff</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="mh">0xFFFF</span><span class="p">))</span>
      <span class="kr">end</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">sub_drivers</span> <span class="o">=</span> <span class="p">{},</span> <span class="c1">-- could optionally nest further.  The can_handles would be chained</span>
  <span class="n">can_handle</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="p">...)</span>
    <span class="kr">return</span> <span class="n">device</span><span class="p">:</span><span class="n">get_manufacturer</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manufacturer_one&quot;</span>
  <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>

<span class="kr">return</span> <span class="n">manufacturer_one_handler</span>
</pre></div>
</div>
</div>
<div class="section" id="manufacturer-two-lua">
<h5>manufacturer_two.lua<a class="headerlink" href="#manufacturer-two-lua" title="Permalink to this headline">¶</a></h5>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.capabilities&quot;</span>
<span class="kd">local</span> <span class="n">zcl_clusters</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;st.zigbee.zcl.clusters&quot;</span>
<span class="kd">local</span> <span class="n">LevelControlCluster</span> <span class="o">=</span> <span class="n">zcl_clusters</span><span class="p">.</span><span class="n">LevelControlCluster</span>

<span class="kd">local</span> <span class="n">manufacturer_two</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;ManufacturerTwo&quot;</span><span class="p">,</span>
  <span class="n">zigbee_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">CurrentLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
          <span class="c1">-- Arbitrarily subtract 5 for example purposes</span>
          <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">level</span><span class="p">(</span><span class="nb">math.floor</span><span class="p">((</span><span class="n">value</span><span class="p">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">254.0</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span>
        <span class="kr">end</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">capability_handlers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="p">.</span><span class="n">switchLevel</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">setLevel</span><span class="p">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="c1">-- Arbitrarily subtract 5 for example purposes</span>
        <span class="kd">local</span> <span class="n">level</span> <span class="o">=</span> <span class="nb">math.floor</span><span class="p">((</span><span class="n">command</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span> <span class="o">*</span> <span class="mi">254</span><span class="p">)</span>
        <span class="n">device</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="n">LevelControlCluster</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">MoveToLevelWithOnOff</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="mh">0xFFFF</span><span class="p">))</span>
      <span class="kr">end</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">sub_drivers</span> <span class="o">=</span> <span class="p">{},</span>
  <span class="n">can_handle</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="p">...)</span>
    <span class="kr">return</span> <span class="n">device</span><span class="p">:</span><span class="n">get_manufacturer</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manufacturer_two&quot;</span>
  <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="subdriver-class-documentation">
<h2>SubDriver Class Documentation<a class="headerlink" href="#subdriver-class-documentation" title="Permalink to this headline">¶</a></h2>
<dl class="lua class">
<dt id="SubDriver">
<em class="property">class </em><code class="sig-name descname">SubDriver</code><a class="headerlink" href="#SubDriver" title="Permalink to this definition">¶</a></dt>
<dd><p>A SubDriver is a way to bundle groups of functionality that overrides the basic behavior of a given driver by gating
it behind a can_handle function.</p>
<dl class="lua attribute">
<dt id="SubDriver.can_handle">
<code class="sig-name descname">can_handle</code><em class="property">: </em>function<a class="headerlink" href="#SubDriver.can_handle" title="Permalink to this definition">¶</a></dt>
<dd><p>(type: Driver, type: Device, …):boolean whether or not this sub driver, if it has a matching handler, should handle a message</p>
</dd></dl>

<dl class="lua attribute">
<dt id="SubDriver.zigbee_handlers">
<code class="sig-name descname">zigbee_handlers</code><em class="property">: </em>table<a class="headerlink" href="#SubDriver.zigbee_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>the same zigbee handlers that a driver would have</p>
</dd></dl>

<dl class="lua attribute">
<dt id="SubDriver.zwave_handlers">
<code class="sig-name descname">zwave_handlers</code><em class="property">: </em>table<a class="headerlink" href="#SubDriver.zwave_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>the same zwave handlers that a driver would have</p>
</dd></dl>

<dl class="lua attribute">
<dt id="SubDriver.capability_handlers">
<code class="sig-name descname">capability_handlers</code><em class="property">: </em>table<a class="headerlink" href="#SubDriver.capability_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>the same capability handlers that a driver would have</p>
</dd></dl>

</dd></dl>

<div class="section" id="driver-tests">
<h3>Driver tests<a class="headerlink" href="#driver-tests" title="Permalink to this headline">¶</a></h3>
<p>It is useful to have a set of unit tests for the functionality of your driver.  You can see documentation on how to
set up driver tests here <a class="reference internal" href="driver_tests.html"><span class="doc">here</span></a></p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="capabilities.html" class="btn btn-neutral float-right" title="Capabilities" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="zwave/generated/ZwaveplusInfo/constants.html" class="btn btn-neutral" title="Constants" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, SmartThings Developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>