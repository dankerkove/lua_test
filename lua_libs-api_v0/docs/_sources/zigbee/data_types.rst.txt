Zigbee Data Types
=================

.. contents::
  :depth: 5

Module Description
------------------

This module contains implementations and utility functions around the usage of Zigbee data types in the lua
environment.  While the individual data types are all defined in their own files these files will be lazily
loaded when using a normal dot syntax with the module.  E.g. ``data_typs.Uint8`` will return the :lua:class:`Uint8 <Uint8>`
class after loading it from it's individual file.

All data type implementations will share a number of characteristics.  First every data type will define the
following functions

Instance functions

:serialize:
    This will serialize the data type into the bytes used to send in a Zigbee message (e.g. Uint16 with a value of 2
    would result in "\\x02\\x00" note that it will be little endian)
:get_length:
    This will return the length of this type in bytes when serialized (e.g. Uint16 would return 2)
:pretty_print:
    This will return a string with a human readable representation of the instance (e.g. "Uint16: 0x0002")

Static functions

:deserialize:
    This will convert from a stream of bytes into the parsed table structure
:__call:
    This is actually defined on the metatable but allows for creation of the type through call syntax (e.g. ``Uint16(0x0002)``)

In addition the data types will have the following fields defined

:ID:
    The Zigbee ZCL specified type ID for this type (e.g. 0x21 for Uint16)
:NAME:
    A string representing the name of the data type (e.g. "Uint16" for Uint16)
:is_discrete:
    A boolean defining if the type is a discrete type
:is_fixed_length:
     A boolean defining if the type is of fixed length

There are 2 exceptions to this rule.  The first is :lua:class:`ZigbeeDataType <ZigbeeDataType>` as this is a representation
of fields in Zigbee messages that represent the data type Ids.  Thus it does not have an ``ID`` field as it is not a
separate data type itself, but in all other functionality it works as a :lua:class:`Uint8 <Uint8>`.  The second
exception is :lua:class:`ZCLCommandId <ZCLCommandId>` for very similar reasons.  It is not an actual Zigbee data type
but is instead used when a message field represents a ZCL command ID.  It also does not have an ID field but otherwise
works identically to a :lua:class:`Uint8 <Uint8>`.

Examples
--------

Creating a data type value
++++++++++++++++++++++++++
Simple creation of some types from raw values

.. code-block:: lua

    -- Import the module
    local data_types = require "st.zigbee.data_types"
    local utils = require "st.zigbee.utils"

    local uint = data_types.Uint16(0x0002)
    uint.NAME  -- "Uint16"
    uint.ID    -- 0x21
    uint.value -- 2

    local int = data_types.Int32(-5)
    int.NAME  -- "Int32"
    int.ID    -- 0x2B
    int.value -- -5
    print(utils.get_print_safe_string(int:serialize()))
    -- "\xFB\xFF\xFF\xFF"


In the context of writing an attribute

.. code-block:: lua

    -- Import the required libraries
    local data_types = require "st.zigbee.data_types"
    local IasEnrollResponseCode = require "st.zigbee.generated.types.enums.IasEnrollResponseCodeEnum"
    local zcl_commands = require "st.zigbee.zcl.global_commands"
    local constants = require "st.zigbee.constants"

    local cie_addr = data_types.IeeeAddress("\x01\x02\x03\x04\x05\x06\x07\x08")
    local attr_id = data_types.AttributeId(IasZoneCluster.attributes.IasCieAddress.ID)
    local data_type_val = data_types.ZigbeeDataType(data_types.IeeeAddress.ID)
    local cie_attr_write = zcl_commands.WriteAttribute.AttributeRecord(attr_id, data_type_val, cie_addr)
    local write_body = zcl_commands.WriteAttribute({ cie_attr_write })

Parsing a data type value from a byte string
++++++++++++++++++++++++++++++++++++++++++++

.. code-block:: lua

    -- Import the required libraries
    local data_types = require "st.zigbee.data_types"

    local bytes = "\xFB\xFF\xFF\xFF"
    local parsed_val = data_types.parse_data_type(data_types.Int32.ID, bytes)
    parsed_val.NAME  -- "Int32"
    parsed_val.ID    -- 0x2B
    parsed_val.value -- -5

    local parsed_val_2 = data_types.Int32.deserialize(bytes)
    parsed_val_2.NAME  -- "Int32"
    parsed_val_2.ID    -- 0x2B
    parsed_val_2.value -- -5

Verifying data types as arguments to other functions
++++++++++++++++++++++++++++++++++++++++++++++++++++

.. code-block:: lua

    -- Import the required libraries
    local data_types = require "st.zigbee.data_types"

    function build_attr_report_record(attr_id, data_type, value)
        local out = {}
        out.attr_id = data_types.validate_or_build_type(attr_id, data_types.AttributeId, "attr_id")
        out.data_type = data_types.validate_or_build_type(data_type, data_types.ZigbeeDataType, "data_type")
        out.data = data_types.validate_or_build_type(value, data_types.get_data_type_by_id(out.data_type.value), "data")
        return out
    end

    local out_table = build_attr_report_record(0x0000, 0x21, 0x0005)
    out_table.attr_id.value    -- 0x0000
    out_table.attr_id.ID       -- 0xE9
    out_table.attr_id.NAME     -- AttributeId
    out_table.data_type.value  -- 0x21
    out_table.data.value       -- 0x0005
    out_table.data.ID          -- 0x21
    out_table.data.NAME        -- Unt16

    local attr_id = data_types.AttributeId(0x0000)
    local data_type_val = data_types.ZigbeeDataType(0x21)
    local data = data_types.Uint16(0x0005)
    local out_table_2 = build_attr_report_record(attr_id, data_type_val, data)
    out_table_2.attr_id.value    -- 0x0000
    out_table_2.attr_id.ID       -- 0xE9
    out_table_2.attr_id.NAME     -- AttributeId
    out_table_2.data_type.value  -- 0x21
    out_table_2.data.value       -- 0x0005
    out_table_2.data.ID          -- 0x21
    out_table_2.data.NAME        -- Unt16


Utility functions
--------------------

.. lua:automodule:: data_types


Custom Data Types
-----------------

.. lua:autoclass:: ZigbeeDataType
.. lua:autoclass:: ZCLCommandId

Zigbee Data Types
-----------------

This is the base type of the DataType classes.  It is abstract and not instatiable itself, and contains no funcitonality
but defines the interface.

.. lua:autoclass:: DataType

NoData
++++++
.. lua:autoclass:: NoDataABC
.. lua:autoclass:: NoData

Data
++++
.. lua:autoclass:: DataABC
.. lua:autoclass:: Data8
.. lua:autoclass:: Data16
.. lua:autoclass:: Data24
.. lua:autoclass:: Data32
.. lua:autoclass:: Data40
.. lua:autoclass:: Data48
.. lua:autoclass:: Data56
.. lua:autoclass:: Data64

Boolean
+++++++
.. lua:autoclass:: BooleanABC
.. lua:autoclass:: Boolean

Bitmap
++++++
.. lua:autoclass:: BitmapABC
.. lua:autoclass:: Bitmap8
.. lua:autoclass:: Bitmap16
.. lua:autoclass:: Bitmap24
.. lua:autoclass:: Bitmap32
.. lua:autoclass:: Bitmap40
.. lua:autoclass:: Bitmap48
.. lua:autoclass:: Bitmap56
.. lua:autoclass:: Bitmap64

Uint
++++
.. lua:autoclass:: UintABC
.. lua:autoclass:: Uint8
.. lua:autoclass:: Uint16
.. lua:autoclass:: Uint24
.. lua:autoclass:: Uint32
.. lua:autoclass:: Uint40
.. lua:autoclass:: Uint48
.. lua:autoclass:: Uint56
.. lua:autoclass:: Uint64

Int
++++
.. lua:autoclass:: IntABC
.. lua:autoclass:: Int8
.. lua:autoclass:: Int16
.. lua:autoclass:: Int24
.. lua:autoclass:: Int32
.. lua:autoclass:: Int40
.. lua:autoclass:: Int48
.. lua:autoclass:: Int56
.. lua:autoclass:: Int64

Enum
++++
.. lua:autoclass:: EnumABC
.. lua:autoclass:: Enum8
.. lua:autoclass:: Enum16

Floating Points
+++++++++++++++
Semi-precision: Not yet implemented
Single-precision: Not yet implemented
Double-precision: Not yet implemented

Strings
+++++++
.. lua:autoclass:: StringABC
.. lua:autoclass:: OctetString
.. lua:autoclass:: CharString
.. lua:autoclass:: LongOctetString
.. lua:autoclass:: LongCharString

Ordered Sequences
+++++++++++++++++
.. lua:autoclass:: ArrayABC
.. lua:autoclass:: Array
.. lua:autoclass:: StructureABC
.. lua:autoclass:: Structure

Collections
+++++++++++
Set: Not yet implemented
Bag: Not yet implemented

Time
++++
.. lua:autoclass:: TimeOfDayABC
.. lua:autoclass:: TimeOfDay
.. lua:autoclass:: DateABC
.. lua:autoclass:: Date
.. lua:autoclass:: UTCTime

Identifiers
+++++++++++
.. lua:autoclass:: ClusterId
.. lua:autoclass:: AttributeId
.. lua:autoclass:: BACNetOId

Miscellaneous
+++++++++++++
.. lua:autoclass:: IeeeAddress
.. lua:autoclass:: SecurityKey
