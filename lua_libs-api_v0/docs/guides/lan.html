

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LAN Edge Device Driver Development Guide &mdash; SmartThings Edge Device Drivers  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="SmartThings Edge Device Drivers  documentation" href="../index.html"/>
        <link rel="up" title="&lt;no title&gt;" href="index.html"/>
        <link rel="next" title="Writing an RPC Client Driver" href="rpc-client.html"/>
        <link rel="prev" title="Package Guide" href="package.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> SmartThings Edge Device Drivers
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Guides:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="first-driver.html">Writing your first Lua driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="package.html">Package Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">LAN Edge Device Driver Development Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-network-sockets">Basic Network Sockets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#programming-model">Programming Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restful-http">RESTful HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#direct-socket-protocols">Direct Socket Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persistent-tcp-connection">Persistent TCP Connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#udp">UDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tls">TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#server-applications">Server Applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="rpc-client.html">Writing an RPC Client Driver</a></li>
</ul>
<p class="caption"><span class="caption-text">References:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lua_environment.html">Lua Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log.html">Logging Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">Utils Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../buf.html">Buffer Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/zigbee.html">Zigbee Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zwave/zwave.html">Z-Wave Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../capabilities.html">Capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../device.html">Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dispatchers.html">Dispatchers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver_tests.html">Driver Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datastore.html">Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../socket.html">Socket Library</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SmartThings Edge Device Drivers</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">&lt;no title&gt;</a> &raquo;</li>
        
      <li>LAN Edge Device Driver Development Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/guides/lan.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lan-edge-device-driver-development-guide">
<h1>LAN Edge Device Driver Development Guide<a class="headerlink" href="#lan-edge-device-driver-development-guide" title="Permalink to this headline">¶</a></h1>
<p>Edge device drivers have introduced the ability to write far more specialized
integrations for Hub Connected devices. If your device has a local network API,
an Edge Driver will allow you to integrate your device into the SmartThings
Platform.</p>
<p>Before reading this guide, be sure to review <a class="reference internal" href="getting-started.html"><span class="doc">getting started</span></a> and <a class="reference internal" href="first-driver.html"><span class="doc">writing your first driver</span></a> to
better understand the content presented here.</p>
<p>LAN drivers can be much more complicated than Zigbee or Z-Wave drivers due to
there being little standardization in how LAN device communication works. This
means that SmartThings is able to offer fewer libraries that handle translation
to and from capability definitions and network messages.  Most devices will have
some level of custom protocol implementation required.</p>
<div class="section" id="basic-network-sockets">
<h2>Basic Network Sockets<a class="headerlink" href="#basic-network-sockets" title="Permalink to this headline">¶</a></h2>
<p>At the lowest level, your driver will be interacting with the physical devices
on your network via sockets. We provide a <a class="reference external" href="http://w3.impa.br/~diego/software/luasocket/">LuaSocket</a>-like api which provides a POSIX
socket interface.  If you’ve ever done any socket programming using functions
like <code class="docutils literal notranslate"><span class="pre">bind</span></code>, <code class="docutils literal notranslate"><span class="pre">send</span></code>, <code class="docutils literal notranslate"><span class="pre">receieve</span></code>, and <code class="docutils literal notranslate"><span class="pre">select</span></code> on TCP and UDP sockets,
you’ll be right at home.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a reimplementation of the lowest level APIs made to support network
access across our sandbox boundary. At the time of writing (October 22 2020),
we have <em>nearly</em> full API support, but some of the more esoteric interfaces,
such as <code class="docutils literal notranslate"><span class="pre">getstats</span></code>, <code class="docutils literal notranslate"><span class="pre">setstats</span></code>, and <code class="docutils literal notranslate"><span class="pre">setoptions</span></code> are not fully
supported. See the <a class="reference internal" href="../socket.html"><span class="doc">socket API reference</span></a> for more details
on which APIs aren’t supported. If you have a strong need for anything that’s
not currently supported or encounter anything in the API that doesn’t seem
to match the behavior you see from LuaSocket, please <a class="reference external" href="https://community.smartthings.com/">let us know</a>.</p>
</div>
<p>Providing this API gives a few key benefits. Besides being a known complete and
useful API, it means that you may be able to use existing Lua libraries or, if
none exist, it allows you to do all initial development in whatever tools you’d
like fully locally on your own system.</p>
<p>We suggest you start development of all LAN Edge Device Drivers by creating a
basic library for your device that supports:</p>
<ol class="arabic simple">
<li><p>Discovering one or more devices on the network from one or more already known
unique device IDs. Usually done using SSDP, mDNS, or some other
multicast/broadcast network request.</p></li>
<li><p>Providing some sort of handle to an individual device that provides:</p></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><p>Functions to send standard requests such as “on” and “off” for a basic
bulb.</p></li>
<li><p>Supporting features such as automatic re-connection and re-discovery if,
for example, the device’s IP address has changed.</p></li>
</ol>
</div></blockquote>
<p>This allows you to develop a library for reliable communication with your device
that is useful both inside and outside of the SmartThings ecosystem.</p>
</div>
<div class="section" id="programming-model">
<h2>Programming Model<a class="headerlink" href="#programming-model" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may make sense to move this section to a more generic section since it
applies to more than just LAN, but it needs to exist for what I’m about to
write so I’m writing it here.</p>
</div>
<p>Responses to network requests, even on you local network, don’t come back
instantaneously. This is especially true in cases like network errors or sending
requests to offline devices. In these circumstances, devices may fall back to
timeouts which can be many seconds long.</p>
<p>Additionally, due to the low amount of resources available to Edge Drivers, a
driver must handle all of its responsibilities from a single OS thread.</p>
<p>This means that code written to rely on standard blocking socket APIs will
almost certainly lead to strange latency issues like popcorning when turning on
more than one light/switch at a time. To remedy this, we can use non-blocking
sockets. These are sockets that instead of blocking your program when no
progress can be made, return an error that tells you to try again later.
Non-blocking sockets solve the popcorning problem, but writing code that
directly uses non-blocking sockets is difficult to get right and makes for more
complicated drivers.</p>
<p>Thanks to Lua’s support of <a class="reference external" href="https://www.lua.org/pil/9.html">coroutines</a>, it is
possible to create an interface that looks like the standard blocking socket
interface, but by using non-blocking sockets is able to block only a single
coroutine. Edge Drivers take advantage of this support to provide such an
interface.</p>
<p>When your code is running in an Edge Driver, all socket operations should use
the socket interface provided by the <code class="docutils literal notranslate"><span class="pre">cosock</span></code> library, <code class="docutils literal notranslate"><span class="pre">cosock.socket</span></code>. This
API passes through all documented LuaSocket APIs exactly as-is. The one
exception is when a call returns a <code class="docutils literal notranslate"><span class="pre">timeout</span></code> error, in which case it yields
the current coroutine until a call to <code class="docutils literal notranslate"><span class="pre">socket.select</span></code> indicates that the
socket is ready, at which point the coroutine is resumed and continues executing
exactly as if it had been blocked by a standard blocking socket operation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Driver</span></code> framework will run each of your event callbacks in a coroutine
dedicated to a particular device. This means you do not need to worry about an
error connecting to one device preventing control of another. You also do not
have to worry about what happens when an event comes in while you’re waiting for
a device to respond to you. Events are inherently processed in order only after
the last event has been processed.</p>
<p>This means that things like handling retries can be implemented as a
straightforward loop in a single function. This makes most IoT device
communication patterns very simple. Below, we take a look at some of the most
common communication patterns.</p>
</div>
<div class="section" id="restful-http">
<h2>RESTful HTTP<a class="headerlink" href="#restful-http" title="Permalink to this headline">¶</a></h2>
<p>Devices utilizing a RESTful HTTP API are the most common LAN devices on the
SmartThings platform today. LAN Devices are a great place to start thanks to
their wide-spread use, and for their use of short lived network operations and
distinct client or server roles.</p>
<p>For all of the code contained in this section, assume we are inside the
capability command handler for the <code class="docutils literal notranslate"><span class="pre">on</span></code> command of a <code class="docutils literal notranslate"><span class="pre">switch</span></code>. This code
will also work in a Lua REPL on your local machine if you have LuaSocket
installed and started with <code class="docutils literal notranslate"><span class="pre">lua</span> <span class="pre">-l</span> <span class="pre">socket</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">http</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;socket.http&quot;</span>

<span class="n">local</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">ip</span> <span class="o">--</span> <span class="n">found</span> <span class="n">previously</span> <span class="n">via</span> <span class="n">discovery</span>
<span class="n">local</span> <span class="n">port</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">port</span> <span class="o">--</span> <span class="n">found</span> <span class="n">previously</span> <span class="n">via</span> <span class="n">discovery</span>

<span class="n">local</span> <span class="n">url</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">/switch&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="n">do</span>
  <span class="o">--</span> <span class="n">performs</span> <span class="n">a</span> <span class="n">POST</span> <span class="n">because</span> <span class="n">body</span> <span class="n">parameter</span> <span class="ow">is</span> <span class="n">passed</span>
  <span class="n">local</span> <span class="n">body</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">({</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">unfortunately</span> <span class="n">required</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">timeout</span> <span class="n">locally</span>
    <span class="n">create</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span>
      <span class="n">local</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">tcp</span><span class="p">()</span>
      <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">sock</span>
    <span class="n">end</span>
  <span class="p">})</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">~=</span> <span class="s2">&quot;timeout&quot;</span> <span class="n">then</span>
    <span class="n">local</span> <span class="n">err</span> <span class="o">=</span> <span class="n">code</span> <span class="o">--</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">case</span> <span class="n">second</span> <span class="n">param</span> <span class="ow">is</span> <span class="n">error</span> <span class="n">message</span>

    <span class="n">error</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;error while setting switch status for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">err</span><span class="p">))</span>
   <span class="n">elseif</span> <span class="n">status</span> <span class="o">~=</span> <span class="mi">200</span> <span class="n">then</span>
     <span class="n">error</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;unexpected HTTP error response from </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">status</span><span class="p">))</span>
  <span class="n">elseif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">break</span>
  <span class="n">end</span>

  <span class="o">--</span> <span class="n">loop</span> <span class="k">if</span> <span class="n">timeout</span>
<span class="n">end</span>
</pre></div>
</div>
<p>TODO: talk about servers for async notifications</p>
<p>TODO: talk about 39500 conversions</p>
</div>
<div class="section" id="direct-socket-protocols">
<h2>Direct Socket Protocols<a class="headerlink" href="#direct-socket-protocols" title="Permalink to this headline">¶</a></h2>
<p>Edge Drivers also support devices that use lower level and custom protocols, as
long as the protocol is based on TCP or UDP. The following sections will show
how to do this with a few of the most common patterns.</p>
</div>
<div class="section" id="persistent-tcp-connection">
<h2>Persistent TCP Connection<a class="headerlink" href="#persistent-tcp-connection" title="Permalink to this headline">¶</a></h2>
<p>One of the most common low-level patterns encountered in household IoT devices
is what SmartThings refers to as a TCP line protocol. This is where a TCP
connection is established with a device and commands are sent as text, often as
JSON, followed by a newline character. Replies from the device are sent in the
same manner. Sometimes asynchronous event notifications are also sent by the
device to any currently connected sockets when a state is changed, such as when
a bulb is turned on via a directly connected mobile app or a message from its
manufacturer’s cloud.</p>
<p>This example will show how to handle these devices.</p>
<p>TODO: Show combination of <code class="docutils literal notranslate"><span class="pre">Device.register_socket</span></code> and handling blocking
request-response with a single socket.</p>
</div>
<div class="section" id="udp">
<h2>UDP<a class="headerlink" href="#udp" title="Permalink to this headline">¶</a></h2>
<p>It is possible to connect to devices using UDP sockets.</p>
</div>
<div class="section" id="tls">
<h2>TLS<a class="headerlink" href="#tls" title="Permalink to this headline">¶</a></h2>
<p>TLS (Transport Layer Security) is a network protocol that can be used to secure
basic network sockets. TLS is supported with a re-implementation of the <a class="reference external" href="https://github.com/brunoos/luasec/wiki">LuaSec</a> API. There are a few subtle
differences to notice; see the reference for more information.</p>
</div>
<div class="section" id="server-applications">
<h2>Server Applications<a class="headerlink" href="#server-applications" title="Permalink to this headline">¶</a></h2>
<p>All of the examples so far have assumed that the SmartThings Hub is acting as a
network client to a device’s server. While this is the most common way
devices operate historically, it is not the only option.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is currently a limitation in calls to <code class="docutils literal notranslate"><span class="pre">bind</span></code> that only allow
you to bind to port 0, which is to say, you cannot specify which port you bind
to, you can only request that one is assigned randomly. And the value of this
port will be random each time your script is restarted. This limitation is in
place to prevent two scripts interfering with each other by both trying to bind
to the same port. We have ideas about how to get around this, but nothing
implemented yet. That means that at least for now your device will need to have
some sort of discovery mechanism to discover the server’s port (and ip).</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rpc-client.html" class="btn btn-neutral float-right" title="Writing an RPC Client Driver" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="package.html" class="btn btn-neutral" title="Package Guide" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, SmartThings Developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>